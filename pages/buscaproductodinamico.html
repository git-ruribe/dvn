<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">Productos</div>
      </div>
    </div>
    <div class="page-content">

      <div class="list no-hairlines-md">
        <div class="block-header">Dropdown With Ajax-Data</div>
        <ul>
          <li class="item-content item-input">
            <div class="item-inner">
              <div class="item-title item-label">Nombre Producto</div>
              <div class="item-input-wrap">
                <input type="text" placeholder="Escriba para autocompletar" id="autocomplete-dropdown-ajax"/>
                <span class="input-clear-button"></span>
              </div>
            </div>
          </li>
        </ul>
      </div>

    </div>
  </div>
</template>
<script>
  return {
    data: function () {
      return {
        fruits: 'Apple Apricot Avocado Banana Melon Orange Peach Pear Pineapple'.split(' '),
      };
    },
    on: {
      pageBeforeRemove() {
        var self = this;
        // Destroy all autocompletes
        self.autocompleteDropdownAjax.destroy();
      },
      pageInit: function () {
        var self = this;
        var app = self.$app;
        var fruits = self.fruits;
        var $ = self.$;

        // Dropdown with ajax data
        self.autocompleteDropdownAjax = app.autocomplete.create({
          inputEl: '#autocomplete-dropdown-ajax',
          openIn: 'dropdown',
          preloader: true, //enable preloader
          /* If we set valueProperty to "id" then input value on select will be set according to this property */
          valueProperty: 'nombre', //object's "value" property name
          textProperty: 'nombre', //object's "text" property name
          limit: 20, //limit to 20 results
          dropdownPlaceholderText: '...',
          source: function (query, render) {
            var autocomplete = this;
            var results = [];
            if (query.length === 0) {
              render(results);
              return;
            }
            // Show Preloader
            autocomplete.preloaderShow();

            // Do Ajax request to Autocomplete data
            app.request({
              url: './data/productos.json',
              method: 'GET',
              dataType: 'json',
              //send "query" to server. Useful in case you generate response dynamically
              data: {
                query: query,
              },
              success: function (data) {
                // Find matched items, lo hice doble para que muestre primero los valores que empiezan con la busqueda
                for (var i = 0; i < data.length; i++) {
                  if (data[i].nombre.toLowerCase().indexOf(query.toLowerCase()) === 0) results.push(data[i]);
                }
                for (var i = 0; i < data.length; i++) {
                  if (data[i].nombre.toLowerCase().indexOf(query.toLowerCase()) >= 1) results.push(data[i]);
                }
                // Hide Preoloader
                autocomplete.preloaderHide();
                // Render items by passing array with result items
                render(results);
              }
            });
          }
        });

      }
    }
  }
</script>
